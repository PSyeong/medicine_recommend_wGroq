<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë³µì•½ìˆ˜ì²© | ì˜ì•½í’ˆ ì •ë³´</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif; background: #f5f5f5; padding: 1rem; color: #333; }
    .pdf-page { max-width: 210mm; margin: 0 auto; background: #fff; padding: 20mm; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .pdf-title { font-size: 1.5rem; font-weight: 700; color: #059669; margin-bottom: 1.5rem; padding-bottom: 0.5rem; border-bottom: 2px solid #059669; }
    .pdf-section { margin-bottom: 1.25rem; }
    .pdf-section h3 { font-size: 0.95rem; color: #059669; margin-bottom: 0.5rem; }
    .pdf-row { display: flex; gap: 1rem; margin-bottom: 0.4rem; font-size: 0.9rem; }
    .pdf-label { font-weight: 600; min-width: 100px; color: #555; }
    .pdf-value { flex: 1; }
    .pdf-med-list { list-style: none; }
    .pdf-med-item { padding: 0.4rem 0; border-bottom: 1px solid #eee; font-size: 0.9rem; }
    .pdf-med-item:last-child { border-bottom: none; }
    .pdf-notes { font-size: 0.9rem; line-height: 1.6; white-space: pre-wrap; }
    .pdf-footer { margin-top: 1.5rem; font-size: 0.8rem; color: #888; }
    .no-print { margin-top: 1rem; text-align: center; }
    .btn-print { padding: 0.6rem 1.5rem; background: #059669; color: #fff; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; }
    .btn-print:hover { background: #047857; }
    .pdf-error { padding: 2rem; text-align: center; color: #dc3545; }
    .pdf-error-hint { font-size: 0.85rem; color: #666; margin-top: 0.5rem; }
    .hidden { display: none !important; }
    @media print {
      body { background: #fff; padding: 0; }
      .pdf-page { box-shadow: none; padding: 15mm; }
      .no-print { display: none !important; }
    }
  </style>
</head>
<body>
  <div class="pdf-page" id="pdfContent">
    <div class="pdf-error hidden" id="errorMsg">
      <p>ë³µì•½ìˆ˜ì²© ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
      <p class="pdf-error-hint">Â· ê°™ì€ ì»´í“¨í„°ì—ì„œ í…ŒìŠ¤íŠ¸: ì•±ì—ì„œ QR ìƒì„± í›„ ì•„ë˜ "ë¯¸ë¦¬ë³´ê¸°"ë¡œ ì—´ì–´ë³´ì„¸ìš”.</p>
      <p class="pdf-error-hint">Â· íœ´ëŒ€í°ì—ì„œ ë³´ë ¤ë©´ localhostê°€ ì•„ë‹Œ ë°°í¬ëœ ì£¼ì†Œì—ì„œ QRì„ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.</p>
    </div>
    <div id="notebookBody"></div>
  </div>
  <div class="no-print">
    <button class="btn-print" id="printBtn">ğŸ–¨ï¸ PDFë¡œ ì €ì¥ / ì¸ì‡„</button>
  </div>
  <script>
    function decodeHash() {
      let hash = location.hash.slice(1).trim();
      if (!hash) return null;
      try {
        hash = hash.replace(/-/g, '+').replace(/_/g, '/');
        var padding = hash.length % 4;
        if (padding) hash += '='.repeat(4 - padding);
        const binary = atob(hash);
        const bytes = new Uint8Array(binary.length);
        for (var i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
        const decoder = new TextDecoder('utf-8');
        const json = decoder.decode(bytes);
        return JSON.parse(json);
      } catch (e) { console.error('ë³µì•½ìˆ˜ì²© í•´ì‹œ ë””ì½”ë”© ì˜¤ë¥˜:', e); return null; }
    }
    function render(d) {
      const body = document.getElementById('notebookBody');
      const err = document.getElementById('errorMsg');
      if (!body) return;
      if (!d || (!d.name && !d.medications?.length && !d.notes && !d.conditions && !d.allergy)) {
        err.classList.remove('hidden');
        body.innerHTML = '';
        return;
      }
      err.classList.add('hidden');
      body.innerHTML = `
        <h1 class="pdf-title">ë³µì•½ìˆ˜ì²©</h1>
        <div class="pdf-section">
          <h3>í™˜ì ì •ë³´</h3>
          <div class="pdf-row"><span class="pdf-label">ì´ë¦„</span><span class="pdf-value">${(d.name || '-').replace(/</g, '&lt;')}</span></div>
          <div class="pdf-row"><span class="pdf-label">ìƒë…„ì›”ì¼</span><span class="pdf-value">${(d.birth || '-').replace(/</g, '&lt;')}</span></div>
          <div class="pdf-row"><span class="pdf-label">í˜ˆì•¡í˜•</span><span class="pdf-value">${(d.blood || '-').replace(/</g, '&lt;')}</span></div>
          <div class="pdf-row"><span class="pdf-label">ë¹„ìƒì—°ë½ì²˜</span><span class="pdf-value">${(d.emergency || '-').replace(/</g, '&lt;')}</span></div>
        </div>
        <div class="pdf-section">
          <h3>ê±´ê°• ì •ë³´</h3>
          <div class="pdf-row"><span class="pdf-label">ê¸°ì €ì§ˆí™˜</span><span class="pdf-value">${(d.conditions || '-').replace(/</g, '&lt;')}</span></div>
          <div class="pdf-row"><span class="pdf-label">ì•Œë ˆë¥´ê¸°</span><span class="pdf-value">${(d.allergy || '-').replace(/</g, '&lt;')}</span></div>
          <div class="pdf-row"><span class="pdf-label">ì„ì‹ /ìˆ˜ìœ </span><span class="pdf-value">${(d.pregnancy || '-').replace(/</g, '&lt;')}</span></div>
        </div>
        <div class="pdf-section">
          <h3>ë³µìš© ì•½ ëª©ë¡</h3>
          <ul class="pdf-med-list">
            ${(d.medications || []).map(m => `<li class="pdf-med-item">${(m.name || '-').replace(/</g, '&lt;')}${m.dosage ? ' â€” ' + (m.dosage || '').replace(/</g, '&lt;') : ''}</li>`).join('')}
          </ul>
          ${!(d.medications || []).length ? '<p class="pdf-value">-</p>' : ''}
        </div>
        <div class="pdf-section">
          <h3>ë¹„ê³ </h3>
          <p class="pdf-notes">${(d.notes || '-').replace(/</g, '&lt;').replace(/\n/g, '<br>')}</p>
        </div>
        <div class="pdf-footer">ì‘ì„±ì¼: ${d.updatedAt ? new Date(d.updatedAt).toLocaleDateString('ko-KR') : new Date().toLocaleDateString('ko-KR')} Â· ì˜ì•½í’ˆ ì •ë³´</div>
      `;
    }
    const data = decodeHash();
    render(data);
    document.getElementById('printBtn').addEventListener('click', () => window.print());
  </script>
</body>
</html>
